---
title: "Group Lab 2. Mapping Origin-Destination Data on Employment and Industry in the US"
author: "Group 6 (Xinbo Lu, Wenjin Yu, Jody Tran, Doyle Park, Abraham Im)"
date: "January 28, 2019"
output: html_document
---


```{r , message=FALSE, warning=FALSE, echo=FALSE}
<<<<<<< HEAD
library(dplyr)
##Part 2 Preparing Data
###OD Data
#For this step, the purpose is to aggregate each work type, for example, S000 and SA01, and then trim the sum of each work type to fit in the King County census tract 2010. 
=======
>>>>>>> 03f67f42347a2f64680d38e115683a0c6184d235

## read the od csv, and clean up formatting issues
t = read.csv("wa_od_main_JT00_2015.csv")
t$w_geocode<-as.character(t$w_geocode)
t$h_geocode<-as.character(t$h_geocode)
t$w_geocode[which(length(t$w_geocode) == 14)]<-paste0("0",t$w_geocode[which(length(t$w_geocode) == 14)])
t$h_geocode[which(length(t$h_geocode) == 14)]<-paste0("0",t$h_geocode[which(length(t$h_geocode) == 14)])


##Making Columns for worktract and hometract
t$wt<-substr(t$w_geocode,1,11)
t$ht<-substr(t$h_geocode,1,11)

##Aggregating each work type
type_S000 = aggregate(. ~ wt + ht,data=t[,c(3,14,15)],FUN=sum)
type_SA01 = aggregate(. ~ wt + ht,data=t[,c(4,14,15)],FUN=sum)
type_SA02 = aggregate(. ~ wt + ht,data=t[,c(5,14,15)],FUN=sum)
type_SA03 = aggregate(. ~ wt + ht,data=t[,c(6,14,15)],FUN=sum)
type_SE01 = aggregate(. ~ wt + ht,data=t[,c(7,14,15)],FUN=sum)
type_SE02 = aggregate(. ~ wt + ht,data=t[,c(8,14,15)],FUN=sum)
type_SE03 = aggregate(. ~ wt + ht,data=t[,c(9,14,15)],FUN=sum)
type_SI01 = aggregate(. ~ wt + ht,data=t[,c(10,14,15)],FUN=sum)
type_SI02 = aggregate(. ~ wt + ht,data=t[,c(11,14,15)],FUN=sum)
type_SI03 = aggregate(. ~ wt + ht,data=t[,c(12,14,15)],FUN=sum)

##using a df to store the aggregated work type
pre_OD_worktype_tract <- data.frame(type_S000, type_SA01, type_SA02, type_SA03, type_SE01, type_SE02, type_SE03, type_SI01, type_SI02, type_SI03)

##clean up duplicated wt and ht
OD_worktype_tract <- pre_OD_worktype_tract %>%
  select(-contains("t."))

##Importing King Country tract list 
kc <- read.csv("kcTract10.csv")

##change GEOID to wt for the joining/merging process
names(kc)[5] <- ("wt")

##Merging to cut dataset down to just KC tracts
kc_OD=merge(kc,OD_worktype_tract,by="wt")

##clean formatting issues
kc_OD$wt<- as.character(kc_OD$wt)
kc_OD$wt[which(length(kc_OD$wt) == 14)]<-paste0("0",kc_OD$wt[which(length(kc_OD$wt) == 14)])

##output csv 
#write.csv(kc_OD, "OD2015_Alljobs.csv")
```


```{r , message=FALSE, warning=FALSE, echo=FALSE}
## FOR WAC CSV
##Setting up table and cleaning up
w = read.csv("wa_wac_S000_JT00_2015.csv")
w$w_geocode<-as.character(w$w_geocode)
w$w_geocode[which(length(w$w_geocode) == 14)]<-paste0("0",w$w_geocode[which(length(w$w_geocode) == 14)])


##Making Columns for worktract and hometract
w$wt<-substr(w$w_geocode,1,11)


##Aggregating
wtuwac=aggregate(. ~ w$wt,data=w[,c(2,11,13,14,16)],FUN=sum)
colnames(wtuwac)[colnames(wtuwac)=="w$wt"] <- "GEOID"


##Merge w/ King County Tract
kc=read.csv("kcTract10.csv")
names(kc)[1]=paste("wt")
kc$GEOID10<-as.character(kc$GEOID10)
colnames(kc)[colnames(kc)=="GEOID10"] <- "GEOID"
wackc=merge(kc,wtuwac,by="GEOID")


##Adding Combined UMWT (utilities, manufacturing, wholesale trade, and transportation & warehouseing)
wackc["UMWT"]=wackc$CNS03+wackc$CNS05+wackc$CNS06+wackc$CNS08
wackc["UMWTshare"]=wackc$UMWT/wackc$C000

#write.csv(wackc,"wac2015_Alljobs.csv")
```


```{r , message=FALSE, warning=FALSE, echo=FALSE}
## FOR RAC CSV
##Setting up table and cleaning up
r = read.csv("wa_rac_S000_JT00_2015.csv")
r$h_geocode<-as.character(r$h_geocode)
r$h_geocode[which(length(r$h_geocode) == 14)]<-paste0("0",r$h_geocode[which(length(r$h_geocode) == 14)])


##Making Columns for worktract and hometract
r$rt<-substr(r$h_geocode,1,11)


##Aggregating
rturac=aggregate(. ~ r$rt,data=r[,c(2,11,13,14,16)],FUN=sum)
colnames(rturac)[colnames(rturac)=="r$rt"] <- "GEOID"


##Merge w/ King County Tract
names(kc)[1]=paste("rt")
rackc=merge(kc,rturac,by="GEOID")


##Adding Combined UMWT (utilities, manufacturing, wholesale trade, and transportation & warehouseing)
rackc["UMWT"]=rackc$CNS03+rackc$CNS05+rackc$CNS06+rackc$CNS08
rackc["UMWTshare"]=rackc$UMWT/rackc$C000

#write.csv(rackc,"rac2015_Alljobs.csv")
```

## Part 3 - Visualizing and Mapping
### Step 1
The data comes from the US Census, which is a census that is taken by the United States Census Bureau every ten years, and gathers information about the population itself. While the data from the Census is mainly used in population apportionment for dividing up the House of Representatives between the states, much of the data gathered on population itself is also used in research [purposes.](https://populationeducation.org/what-us-census-and-why-it-important/)

However, there are inevitable flaws and problems with using Census data for research purposes. Some general problems with Census data include 'census microdata' and 'interpolated values'. Census microdata is data that is collected at the level of individual respondents and is recorded separately for every person involved. This has the advantage of being able to find relationships between 2 variables and performed detailed analysis for research purposes (unlike aggregated data, which is data combined from several measurements). However, this can be potentially abused and create privacy loss, which is why access to this type of data is often [restricted.](https://www.census.gov/research/data/restricted_use_microdata.html) On the other hand, interpolated values are basically values that are estimated by discovering a pattern between discrete, known data values. As the census data is not collected annually, interpolated values are often used (dependent on Census data) for population estimates between censuses. Of course, this introduces some uncertainity in those values as that there are just estimates based on the Census data [and can be flawed in certain population scenarios.](https://www.wisegeek.com/what-is-interpolation.htm) There are also problems in the how Census data records things, such as the issue with 'Census race categories'.The Census does has a history of contradictions, injustices, and absurdities when asking individuals on how they identify their racial categories. One such problem is how there is a practice of separating 'race' and 'ethnicity' as two different categories, as there are some people who do not see those two as separate categories. This leads to the larger debate on how race/ethnicity should be defined, which is now more commonly viewed as a more fluid product rather than a definite physical [characteristic.](http://www.pewresearch.org/fact-tank/2015/06/18/census-considers-new-approach-to-asking-about-race-by-not-using-the-term-at-all/) 

Our area of interest is King County, Washington, mainly because of the Seattle and Bellevue region there. Specially, as there are many companies, varied infrastructures, and large working population; these factors can be meaningful when we are discussing about growth, employment rate, etc.(and something probably worth to research about, especially since we live in King County).

Our main findings show that

##Part 3
<<<<<<< HEAD
###One non-spatial visualization
```{r , message=FALSE, warning=FALSE, echo=FALSE, fig.width=12, fig.height=12}
## Done by Jody
=======

###Step 2 
####First non-spatial visualization
```{r , message=FALSE, warning=FALSE, echo=FALSE}
>>>>>>> 03f67f42347a2f64680d38e115683a0c6184d235
library(ggplot2)
library(raster)

#plotted all the jobs according to residence block.
alljobs_plot <- ggplot(data=OD_worktype_tract,aes(x=ht, y=S000, color=S000)) +geom_point() +xlab("Residence Block") +ylab("Total Number of Jobs") +ggtitle("Residence-Jobs Relation") +theme_bw()
alljobs_plot

#plotted all the jobs according to workplace block.
ttujobs_plot <- ggplot(data=OD_worktype_tract,aes(x=wt, y=S000, color=S000)) +geom_point() +xlab("Workplace Block") +ylab("Total Number of Jobs") +ggtitle("Workplace-Jobs Relation") +theme_bw()
ttujobs_plot

```
<<<<<<< HEAD

###Proportions of Jobs in Census Blocks where People are Working

```{r, message=FALSE, warning=FALSE, echo=FALSE, fig.width=12, fig.height=12}
=======
We can see that increasingly, people live closer to their workplace so there is more packed data in Residence-Job Relation graph.  Overtime, it is harder for people to commute so they would much rather try to live closer to where they work.


####Second non-spatial visualization
Proportions of Jobs in Census Blocks where People are Working
```{r, message=FALSE, warning=FALSE, echo=FALSE}
>>>>>>> 03f67f42347a2f64680d38e115683a0c6184d235
library(ggplot2)
library(tidyverse)
detach("package:raster", unload = TRUE)

## Loading data
WAC <- read.csv("wac2015_Alljobs.csv")
## Arranging industry data in a format useful to graphing
utilities <- WAC %>%
  select(wt,CNS03) %>%
  rename(njobs = CNS03)
utilities$Type <- rep("Utilities",nrow(utilities))
manufacturing <- WAC %>%
  select(wt,CNS05) %>%
  rename(njobs = CNS05)
manufacturing$Type <- rep("Manufacturing",nrow(manufacturing))
wholesale <- WAC %>%
  select(wt,CNS06) %>%
  rename(njobs = CNS06)
wholesale$Type <- rep("Wholesale Trade",nrow(wholesale))
transware <- WAC %>%
  select(wt,CNS08) %>%
  rename(njobs = CNS08)
transware$Type <- rep("Transportation and Warehousing",nrow(transware))

## Binding the rows of each data frame into one to graph
jobs <- rbind(utilities,manufacturing,wholesale,transware)

## Plotting data and displaying
sectorjobs_plot <- ggplot(data=jobs,aes(x=wt, y=njobs, fill=Type)) + geom_bar(width=3,stat="identity") + xlab("Workplace Block") + ylab("Number of Jobs") + ggtitle("Proportions of Jobs in Census Blocks")
sectorjobs_plot
```

The manufacturing sector seems to hire the most workers, followed by wholesale and then transportation and warehousing, although in a couple of blocks, transportation and warehousing is the dominant sector.


###Part3.3

```{r l233, message=FALSE,warning=FALSE,echo=FALSE, fig.width=12, fig.height=12}
library(tidyverse)
library(reshape2)
kC = read.csv('kcTract10.csv', row.names=1)
kCy <- as.tibble(kC)
names(kCy) <- c("StateFIPS","CountyFIPS","CensusTract","GEOID","FullName"," LegalStatDescript","TIGER_block", "FunctionalStat", "LandArea", "WaterArea", "lat","lon")
wac_a <- read.csv('wac2015_Alljobs.csv', row.names=1)
wac_al <- as.tibble(wac_a)
library(dplyr)
kc_join <- inner_join(kCy,wac_al, by = "GEOID")
# inner join two tibbles to have king county data with lon and lat
kc_joinSelect<- kc_join %>%
  select(GEOID,lon,lat,C000)
names(kc_joinSelect) <- c("GEOID", "lon", "lat","C000")
#select and rename
library(ggmap)
register_google(key = "AIzaSyARcdnMrzlsyq4HEjUd4zWnJP4l4xmXTm0")
kc_ll <- c(lon = -122.1665123,lat = 47.608988)
llkc = cbind(kc_join[,12],kc_join[,11])
kc_map <- get_map(kc_ll, zoom = 9, scale = 2)
ggmap(kc_map)+ geom_point(aes(lon,lat),data = kc_joinSelect)+labs(title = "Scatter plot of C000 - Total Numbers of Jobs in King County", x = "longitude",y = "latitude") 
#scatter plot
ggmap(kc_map,extent = "device",legend = "topleft")+stat_density2d(aes(x = lon, y = lat, fill = ..level..,alpha = ..level..),size = 2, bins = 4, data = kc_joinSelect,geom = "polygon")+labs(title = "Contour plot of C000 - Total Numbers of Jobs in King County", x = "longitude",y = "latitude") 
#contour plot to show concentration
```
<<<<<<< HEAD

###Part3.4

```{r wutt3.4,message=FALSE,warning=FALSE,echo=FALSE, fig.width=12, fig.height=12}
=======
By plotting the contour map, we see the density of how jobs are distributed. The highest density happens from South Lake Union to Northgate. The jobs frequency decreases, as we go towards the periphery of the Greater Seattle Area. We don't see contour shades over East King County and Bainbridge Island, although the scatter plot shows some spots in East King County and Bainbridge Island.  This suggests that there are job opportunities in East King County and Bainbridge, but very minimal.

###Part3.4 
```{r wutt3.4,message=FALSE,warning=FALSE,echo=FALSE}
options(scipen = 999) #turn off scientific notation for tract no.
>>>>>>> 03f67f42347a2f64680d38e115683a0c6184d235
t = read.csv("wa_od_main_JT00_2015.csv")
agg_t <- data.frame(t[,1:3])
library(plyr)
library(reshape2)
agg <- aggregate(S000 ~ h_geocode + w_geocode , agg_t, sum)
library(dplyr)
gga <- agg %>% arrange(desc(S000)) # desc
head(gga)
```
Since the OD data contains the employment relationship between a home census block and a work census block, by aggregate the OD data frame, we get the summarized list of relationship that sorts the retrieved data in ascending order. To further indicate the pattern, we arrange the data in descending order so that we can get the idea of certain hometracts leads to certain worktrack. The work block that workers go the most is 530739400002045, 191 workers from 530739400001034 home block go to work at this worktract. Next in the list is the 530330228033006 worktract.  A total of 177 of 530330228032008 tract-resided workers work in 530330228033006 work block.


###Step6
<<<<<<< HEAD
```{r echo=FALSE, warning=FALSE, message=FALSE, fig.width=12, fig.height=12}
##Calculate Location Quotients (Links to an external site.)Links to an external site. for all of your data, and then "zoom in" to look at the location quotients for the subset of tracts selected from your OD data.
library(raster)
=======
Based on the LQ plot, we can see high clustering of workers younger than 29 working at Western Washington Area. Since the King County shapefile includes waterbodies (some people living on a boat, and US Census includes them as a single tract), thoses tracts has a really high location quotient. This shouldn't affect the study, because we are giving an overview on the distribution of workers in the entire county. This analysis corresponds to our assumption that cities such as Seattle, Bellevue, and Kirkland usually have high clustering of young age workers.
```{r echo=FALSE, warning=FALSE, message=FALSE, fig.width=12, fig.height=10}
##Calculate Location Quotients of OD data.
>>>>>>> 03f67f42347a2f64680d38e115683a0c6184d235
library(maptools)
library(RColorBrewer)
library(tmap)
kcTract<- readShapeSpatial('kc_shp/king10ct.shp')
OD<- read.csv("OD2015_Alljobs.csv")
names(kcTract)

##extract the attribute data of instrest, in this case, it is the percentage of "Number of jobs of workers age 29 or younger" and the "Total Number of jobs", SA01/S000

SA01 <- OD$SA01
S000 <- OD$S000

##Creating a function to calculate the location quotient between SA01 and S000
LQ <- function(SA01, S000){
  sdp <- SA01/S000
  dp <- sum(SA01) / sum(S000)
  sdp/dp
}

##Creating a dataframe to includ working tract, and location quotient
kc_LQ <- data.frame(OD$wt, LQ(SA01, S000))

##Change the column names
colnames(kc_LQ) <- c("wt", "kc_LQ")

##Creating breaks to get choropleth map 
brks<-c(0.5,1,1.5,2,2.5,3,3.5,4,4.5,5)

##Make colors
colours <- brewer.pal(10, "Blues") 

##Plot variables. Using interveral as the classification method
kc_LQPlot <- plot(kcTract, col=colours[findInterval(kc_LQ$kc_LQ, brks, all.inside=TRUE)], axes=F)
box()
<<<<<<< HEAD
title(paste("Location Quotients of Workers 29 and younger and Total Number of Jobs"))
legend("bottomright", legend=leglabs(brks), fill=colours, bty="n", border = "black", title = "Percent of workers <= 29")
=======

##Create title and legend
title(paste("King County Working Tracts, LQ of SA01 and S000"))
legend("bottomright", legend=leglabs(brks), fill=colours, bty="n", border = "black", title = 
         ("Location Quotient for Workers 
          who are 29yrs and below"))
>>>>>>> 03f67f42347a2f64680d38e115683a0c6184d235

```
